# MedEarn Server

A decentralized content storage and monetization server built with Node.js, Express, and Walrus decentralized storage on Sui blockchain. The server implements the **x402 HTTP Payment Protocol** for pay-per-access content monetization.

## Features

- **Decentralized Storage**: Content stored on Walrus decentralized storage network
- **x402 Protocol**: Real implementation of the x402 HTTP Payment Protocol
- **Pay-Per-Access**: Every article requires payment for every access attempt
- **Local Metadata Storage**: Only essential blob information stored locally
- **Content Access Control**: HTTP 402 Payment Required responses following x402 standard
- **Payment Verification**: x402 protocol payment verification and tracking system
- **Instant Content Delivery**: Fast preview retrieval with on-demand full content

## x402 Protocol Implementation

### Overview
This server implements the **x402 HTTP Payment Protocol** as a content provider. The server:

1. **Sends HTTP 402 Payment Required** with payment details
2. **Receives payment payload** from x402 client
3. **Uses x402 middleware** to verify payment locally
4. **If successful, serves content** to client

### x402 Dependencies
The server uses official x402 packages for payment verification:
```bash
npm install @coinbase/x402 x402-express
```

**Note:** These packages provide the facilitator functionality locally - no external API calls are needed.

### Server-Side x402 Implementation
```typescript
// x402 Payment verification endpoint - uses x402 middleware
app.post('/api/blobs/:id/pay', async (req, res) => {
    const { userAddress, paymentPayload } = req.body;
    
    // Use x402 middleware to verify payment
    const paymentVerified = await verifyX402Payment(
        paymentPayload, 
        paymentDetails
    );
    
    if (paymentVerified) {
        // Record payment and grant access
        blobStorage.recordPayment(id, userAddress, paymentId, amount);
        res.json({ success: true, accessGranted: true });
    } else {
        res.status(400).json({ error: 'Payment verification failed' });
    }
});
```

## API Endpoints

### Content Access

#### GET `/api/blobs/preview`
Get preview of all available articles with x402 payment information.

**Response:**
```json
[
  {
    "blobId": "1755367928902",
    "title": "Article Title",
    "description": "Article description",
    "ownerAddress": "0x4ca0d90fb63968fc4327f8dd6c8119fbd745e748c7916a531da273440835b4da",
    "uploadDate": "2025-08-16T18:12:08.902Z",
    "paymentRequired": true,
    "paymentDetails": {
      "price": "0.01",
      "currency": "USDC",
      "network": "base-testnet"
    }
  }
]
```

#### GET `/api/blobs/:id/content?userAddress=0x...`
Get full article content. **Requires x402 payment for every access.**

**Parameters:**
- `id`: Article blob ID
- `userAddress`: User's wallet address (required)

**Responses:**

**HTTP 402 Payment Required (x402 protocol):**
```json
{
  "error": "Payment Required",
  "message": "Access to this content requires payment",
  "paymentDetails": {
    "price": "0.01",
    "currency": "USDC",
    "paymentAddress": "0x4ca0d90fb63968fc4327f8dd6c8119fbd745e748c7916a531da273440835b4da",
    "assetAddress": "0xA0b86991C6218b36c1d19D4a2e9Eb0cE3606EB48",
    "network": "base-testnet",
    "resource": "/api/blobs/1755367928902/content",
    "description": "Access to article: Article Title",
    "expiresAt": "2025-08-17T18:27:32.470Z",
    "nonce": "v9xfdh",
    "paymentId": "pay_1755368852471_18i1t4"
  }
}
```

**HTTP 200 Success (paid):**
```json
{
  "blobId": "1755367928902",
  "title": "Article Title",
  "content": "Full article content...",
  "metadata": {
    "uploadDate": "2025-08-16T18:12:08.902Z",
    "ownerAddress": "0x4ca0d90fb63968fc4327f8dd6c8119fbd745e748c7916a531da273440835b4da",
    "isPublic": false,
    "paymentInfo": {
      "paymentId": "pay_1755368852471_sf8i5m",
      "amount": "0.01",
      "timestamp": "2025-08-16T18:27:32.579Z",
      "accessGranted": true
    }
  }
}
```

### x402 Payment Processing

#### POST `/api/blobs/:id/pay`
Submit x402 payment payload to gain access to content. The server uses x402 middleware to verify the payment locally.

**Request Body:**
```json
{
  "userAddress": "0x1234567890123456789012345678901234567890",
  "paymentPayload": "x402_payment_payload_from_client_library"
}
```

**Response:**
```json
{
  "success": true,
  "message": "x402 payment verified and access granted",
  "paymentId": "pay_1755368852471_sf8i5m",
  "accessGranted": true,
  "expiresAt": "2025-08-17T18:27:32.580Z"
}
```

**Note:** The `paymentPayload` should be generated by the x402 client library. The server uses x402 middleware to verify the payment locally without external API calls.

## Frontend Implementation Guide

### 1. x402 Client Library

Use the provided x402 client example:

```bash
# Run the x402 client demonstration
node x402-client-example.js
```

### 2. Basic x402 Implementation

```javascript
import { X402Client } from './x402-client-example.js';

const client = new X402Client('http://localhost:8000', userWalletAddress);

// Access article with automatic x402 payment handling
const result = await client.accessArticleWithX402(articleId);

if (result.success) {
    displayArticle(result.content);
} else {
    // Handle payment required
    showPaymentForm(result.paymentInfo);
}
```

### 3. Handle HTTP 402 (x402 Protocol)

```javascript
async function getArticleContent(blobId, userAddress) {
    try {
        const response = await fetch(`/api/blobs/${blobId}/content?userAddress=${userAddress}`);
        
        if (response.status === 200) {
            // Payment already made, return content
            const content = await response.json();
            return { success: true, content };
        } else if (response.status === 402) {
            // x402 Payment Required - this is expected behavior
            const paymentInfo = await response.json();
            return { success: false, paymentRequired: true, paymentInfo };
        } else {
            throw new Error(`Unexpected response: ${response.status}`);
        }
    } catch (error) {
        console.error('Error fetching content:', error);
        throw error;
    }
}
```

### 4. x402 Payment Flow

```javascript
async function handleX402Payment(blobId, userAddress, paymentInfo) {
    // Step 1: Create x402 payment payload using client library
    const paymentPayload = await x402Client.createPayment({
        amount: paymentInfo.paymentDetails.price,
        currency: paymentInfo.paymentDetails.currency,
        recipient: paymentInfo.paymentDetails.paymentAddress,
        asset: paymentInfo.paymentDetails.assetAddress,
        network: paymentInfo.paymentDetails.network
    });
    
    // Step 2: Submit payment payload to server (server verifies locally with x402 middleware)
    const verifyResponse = await fetch(`/api/blobs/${blobId}/pay`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            userAddress,
            paymentPayload: paymentPayload
        })
    });
    
    if (verifyResponse.ok) {
        // Payment verified by x402 middleware, now fetch content
        return await getArticleContent(blobId, userAddress);
    } else {
        throw new Error('x402 payment verification failed');
    }
}
```

### 5. Complete x402 Article Access

```javascript
async function accessArticleWithX402(blobId, userAddress) {
    try {
        // Try to get content
        const result = await getArticleContent(blobId, userAddress);
        
      if (result.success) {
            // User has already paid, show content
            displayArticle(result.content);
        } else if (result.paymentRequired) {
            // x402 payment required, handle payment flow
            const content = await handleX402Payment(blobId, userAddress, result.paymentInfo);
            if (content.success) {
                displayArticle(content.content);
            }
        }
    } catch (error) {
        console.error('Error accessing article:', error);
        showErrorMessage('Failed to access article');
    }
}
```

## Important Notes for Frontend Developers

### x402 Protocol Requirements
- **HTTP 402 is the standard x402 response** - not an error
- **Payment proof must be blockchain transaction** - not fake data
- **Every access requires new payment** - no sharing between users
- **Payment verification is on-chain** - server validates blockchain transactions

### User Address
- **Always required** - must be provided for every content request
- **Used for payment tracking** - determines if user has paid
- **Should be the user's actual wallet address** - for blockchain verification

### HTTP 402 Handling
- **HTTP 402 is expected** for unpaid access - this is x402 protocol
- **Always check for 402 status** before treating as error
- **Payment information is in the response body** - use it for payment UI

### Content Retrieval
- **Content is fetched from Walrus** after x402 payment verification
- **Content includes payment metadata** - useful for user history
- **Content access is one-time** - next access requires new x402 payment

## Testing

Use the provided test scripts to verify the x402 system:

```bash
# Test x402 system with existing articles
node test-existing-articles.js

# Test complete x402 flow (requires WAL tokens)
node test-pay-per-access.js

# Test x402 client implementation
node x402-client-example.js
```

## Environment Variables

```bash
# Required for Walrus functionality
SUI_PRIVATE_KEY=suiprivkey...
SUI_PUBLIC_KEY=0x...
WALRUS_RPC_URL=https://...

# Server configuration
PORT=8000
```

## Installation

```bash
npm install
npm install @coinbase/x402 x402-express
npm run build
npm start
```

The server will run on `http://localhost:8000` by default.

## Architecture

- **Express.js** - REST API server with x402 protocol
- **x402 Protocol** - Official Coinbase x402 implementation
- **Walrus** - Decentralized content storage
- **Sui Blockchain** - Payment verification and storage
- **Local Storage** - Article metadata and payment tracking
- **Pay-Per-Access** - x402 protocol monetization model

This system implements the real x402 HTTP Payment Protocol, ensuring secure, blockchain-verified payments for every piece of content while providing a seamless user experience through proper HTTP status codes and clear payment flows. 